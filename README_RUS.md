# Документация API Сервиса Синхронизации Файлов

## Описание

Сервис синхронизации файлов предназначен для автоматической синхронизации файлов между локальной папкой и облачным хранилищем [Яндекс.Диск](https://yandex.ru/dev/disk/poligon/). Приложение отслеживает изменения в локальной папке и обновляет соответствующие файлы в облачном хранилище.

## Установка

Для работы вам понадобится токен доступа к Яндекс Диску. Чтобы получить его, зарегистрируйтесь или войдите в свой аккаунт в Яндексе, а затем перейдите на [сайт](https://yandex.ru/dev/disk/poligon/) для генерации токена. Здесь же вы можете попробовать различные методы работы с публичным API Яндекс Диска.
Авторизация осуществляется по протоколу AOuth 2.0. При составлении запроса используется заголовок `Authorization: OAuth <ваш_токен>`. 


Для работы сервиса необходимо установить зависимости:

```pythonregexp
pip install -r requirements.txt
```

## Конфигурация

Параметры работы сервиса задаются в файле `.env`:

```dotenv
# Путь к локальной папке, которую нужно синхронизировать
SYNC_FOLDER=D:\test

# Путь к папке на Яндекс.Диске, куда будут загружаться файлы
YANDEX_FOLDER=backup

# Токен для доступа к API Яндекс.Диска
YANDEX_TOKEN=<YOUR-YANDEX-DISK-TOKEN>

# Интервал синхронизации в секундах
SYNC_INTERVAL=10

# Путь к файлу журнала
LOG_FILE=log\sync.log

# Уровень логирования для вывода в консоль
LOG_LEVEL="INFO"

# Уровень логирования для записи в файл
LOG_FILE_LEVEL="DEBUG"

# Максимальный размер файла журнала перед его ротацией
LOG_ROTATION="1 MB"

# Метод сжатия для архивирования старых файлов журнала
LOG_COMPRESSION="zip"
```

## Основные функции

- **Связывание указанной папки на локальном компьютере с облачным хранилищем.**

- **Отслеживание изменений файлов в локальной папке и их обновление в облаке.**

- **Автоматическая загрузка новых или изменённых файлов.**

- **Удаление файлов из облака, если они удалены локально.**

- **Логирование операций и ошибок.**

- **Полная синхронизация всех вложенных каталогов и файлов.**

## Структура проекта

```
/
|-- api/api.py          # Логика работы с API Яндекс.Диска
|-- log/                # Логи работы 
|-- main.py             # Основной файл запуска синхронизации
|-- .env                # Конфигурационный файл
|-- requirements.txt    # Зависимости проекта
|-- README_RUS.md       # Дополнительная документация
```

## Использование

### Запуск сервиса

Для запуска сервиса выполните:

```pythonregexp
python main.py
```

### Основной алгоритм работы

1. Загружаются переменные окружения из `.env`.
2. Проверяется существование локальной папки.
3. Выполняется синхронизация файлов и всех вложенных каталогов между локальной папкой и Яндекс.Диском.
4. Повторная синхронизация выполняется через заданный `SYNC_INTERVAL` секунд.

### Алгоритм синхронизации файлов и папок

1. Получается список всех файлов и каталогов в локальной папке.
2. Получается список файлов и папок в соответствующем каталоге на Яндекс.Диске.
3. Для каждого локального файла вычисляется его хеш (MD5) и сравнивается с соответствующим файлом в облаке.
4. Если файла нет в облаке или его хеш не совпадает, он ставится в очередь на загрузку.
5. Если в облаке есть файлы, которых нет локально, они ставятся в очередь на удаление.
6. Все файлы загружаются асинхронно с ограничением по количеству одновременных запросов.
7. Завершается текущий цикл и запускается новый через заданный `SYNC_INTERVAL`.

## Класс `YandexDiskAPI`

### `__init__(self, token, folder)`

Создаёт объект для работы с API Яндекс.Диска.

- **token** (str) — OAuth-токен для доступа.
- **folder** (str) — Корневая папка в облачном хранилище.

### `sync_folder(self, local_folder)`

Синхронизирует локальную папку с облаком.

- **local\_folder** (str) — Путь к локальной папке.

### `upload(self, session, file_path, remote_path)`

Загружает файл в облако.

- **file\_path** (str) — Локальный путь.
- **remote\_path** (str) — Путь в облаке.

### `delete(self, session, remote_path_to_file)`

Удаляет файл из облака.

- **remote\_path\_to\_file** (str) — Путь удаляемого файла.

### `get_info(self, session, remote_dir_path)`

Получает информацию о файлах в облаке.

- **remote\_dir\_path** (str) — Путь к папке в облаке.

## Сравнение файлов перед синхронизацией

Перед загрузкой файлов программа сравнивает локальный и облачный вариант по их хешу (MD5). Если хеши совпадают, загрузка не выполняется, что экономит трафик и снижает нагрузку на сервер. Если хеши различаются, файл ставится в очередь на загрузку.

## Логирование

Логи записываются в файл, указанный в `LOG_FILE`. Пример лога:

```stylint
2025-02-02 03:45:58.675 | INFO     | __main__:main:44 - Запуск службы синхронизации
2025-02-02 03:45:58.675 | INFO     | __main__:sync_files:39 - Начало рекурсивной синхронизации вложенных каталогов
2025-02-02 03:47:10.328 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3 успешно создана и проверена
2025-02-02 03:47:10.558 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/homework успешно создана и проверена
2025-02-02 03:47:10.797 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/homework/hw1 успешно создана и проверена
2025-02-02 03:47:11.089 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/homework/hw2 успешно создана и проверена
2025-02-02 03:47:11.424 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/homework/hw3 успешно создана и проверена
2025-02-02 03:47:11.583 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/homework/img успешно создана и проверена
2025-02-02 03:47:11.779 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/materials успешно создана и проверена
2025-02-02 03:47:12.125 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/materials/primary_key успешно создана и проверена
2025-02-02 03:47:12.581 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/materials/sql_join успешно создана и проверена
2025-02-02 03:47:12.787 | INFO     | api.api:create_folders_first:75 - Папка backup/module_16_db3/practice успешно создана и проверена
2025-02-02 03:47:13.279 | INFO     | api.api:create_folders_first:75 - Папка backup/sync успешно создана и проверена
2025-02-02 03:47:13.702 | INFO     | api.api:create_folders_first:75 - Папка backup/sync/api успешно создана и проверена
2025-02-02 03:47:14.033 | INFO     | api.api:create_folders_first:75 - Папка backup/sync/api/__pycache__ успешно создана и проверена
2025-02-02 03:47:14.312 | INFO     | api.api:create_folders_first:75 - Папка backup/theory успешно создана и проверена
2025-02-02 03:48:14.328 | INFO     | __main__:sync_files:39 - Начало рекурсивной синхронизации вложенных каталогов
2025-02-02 03:48:15.684 | INFO     | api.api:sync_directory:129 - Файл sync.log поставлен в очередь на загрузку. 
2025-02-02 03:48:15.684 | INFO     | api.api:sync_directory:130 -   Локальный хеш: 9ccf8f9eec84274c9eb4e9647df4ff33
2025-02-02 03:48:15.684 | INFO     | api.api:sync_directory:131 -    Облачный хеш: fdefd898caca27a379ba722adf36cbf6
2025-02-02 03:48:15.708 | INFO     | api.api:sync_directory:129 - Файл api.py поставлен в очередь на загрузку. 
2025-02-02 03:48:15.708 | INFO     | api.api:sync_directory:130 -   Локальный хеш: 80a56dd5e451b4c32ad51817e7783017
2025-02-02 03:48:15.708 | INFO     | api.api:sync_directory:131 -    Облачный хеш: 41326c1c24b26248a122f6ca0bf65529
2025-02-02 03:48:15.800 | INFO     | api.api:sync_directory:129 - Файл api.cpython-312.pyc поставлен в очередь на загрузку. 
2025-02-02 03:48:15.800 | INFO     | api.api:sync_directory:130 -   Локальный хеш: b5441a8870a278793c25c79cb877d3a1
2025-02-02 03:48:15.800 | INFO     | api.api:sync_directory:131 -    Облачный хеш: 4f748ba8fa3007bb29f7c497ede009ff
2025-02-02 03:48:16.606 | WARNING  | api.api:upload:173 - Файл backup/async/api/__pycache__/api.cpython-312.pyc загружен
2025-02-02 03:48:17.232 | WARNING  | api.api:upload:173 - Файл backup/async/api/api.py загружен
2025-02-02 03:48:17.655 | WARNING  | api.api:upload:173 - Файл backup/async/log/sync.log загружен

```

## Плюсы и минусы

### Плюсы:

- **Асинхронная загрузка** — использование `asyncio` позволяет выполнять несколько загрузок одновременно, ускоряя процесс синхронизации.
- **Хеширование файлов** — передача измененных файлов только при необходимости.
- **Гибкость** — возможность конфигурации через `.env`.
- **Устойчивость к сбоям** — ошибки логируются, но не прерывают выполнение программы.
- **Поддержка вложенных каталогов** — синхронизация всех файлов и папок.
- **Проверка имен файлов и папок** — обработка ошибок, связанных с недопустимыми символами.

### Минусы:

- **Зависимость от Яндекс.Диска** — сервис не поддерживает другие облачные хранилища.
- **Необработанные частные сценарии** — возможны ошибки при работе с длинными именами файлов или специфическими символами в именах.

## Ошибки и обработка исключений

Программа не завершает работу при ошибках сети или доступе к файлам. Ошибки записываются в лог-файл и продолжается выполнение остальных задач.

## Заключение

Программа позволяет эффективно синхронизировать файлы с Яндекс.Диском, обеспечивая автоматическое обновление и удаление файлов в облаке.

